



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>Designing data intensive application - Data - AI - Analytics Reference Architecture</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#designing-data-intensive-applications" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Data - AI - Analytics Reference Architecture" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Data - AI - Analytics Reference Architecture
            </span>
            <span class="md-header-nav__topic">
              Designing data intensive application
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/ibm-cloud-architecture/refarch-data-ai-analytics/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Data - AI - Analytics Reference Architecture" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Data - AI - Analytics Reference Architecture
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/ibm-cloud-architecture/refarch-data-ai-analytics/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../" title="AI Ladder" class="md-nav__link">
      AI Ladder
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Data & AI Architectures
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Data & AI Architectures
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../dataprinciples/" title="Architecture Principles" class="md-nav__link">
      Architecture Principles
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../preparation/gov-data-lake/" title="Collect - organize data" class="md-nav__link">
      Collect - organize data
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../model-dev/" title="Analyze & build model" class="md-nav__link">
      Analyze & build model
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../runtimes/" title="Infuse in application" class="md-nav__link">
      Infuse in application
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Collect and Organize
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Collect and Organize
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../topology/" title="Data Topology" class="md-nav__link">
      Data Topology
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../preparation/data-replication/" title="Data replication" class="md-nav__link">
      Data replication
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Analyze
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Analyze
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../preparation/data-understanding/" title="Data Understanding" class="md-nav__link">
      Data Understanding
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../preparation/" title="Data Preparation" class="md-nav__link">
      Data Preparation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../preparation/" title="Bias picking right training set" class="md-nav__link">
      Bias picking right training set
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../preparation/" title="Model selection" class="md-nav__link">
      Model selection
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" checked>
    
    <label class="md-nav__link" for="nav-6">
      Infuse
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Infuse
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Designing data intensive application
      </label>
    
    <a href="./" title="Designing data intensive application" class="md-nav__link md-nav__link--active">
      Designing data intensive application
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#context" title="Context" class="md-nav__link">
    Context
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#distributed-data" title="Distributed data" class="md-nav__link">
    Distributed data
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#replication" title="Replication" class="md-nav__link">
    Replication
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-leader" title="Single leader" class="md-nav__link">
    Single leader
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-leader" title="Multi leader" class="md-nav__link">
    Multi leader
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compendium" title="Compendium" class="md-nav__link">
    Compendium
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployment/" title="CI & CD" class="md-nav__link">
      CI & CD
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployment/" title="Physical model execution" class="md-nav__link">
      Physical model execution
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Monitoring
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Monitoring
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../monitoring/" title="Feedback analysis" class="md-nav__link">
      Feedback analysis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../monitoring/" title="Bias monitoring to ensure equitable" class="md-nav__link">
      Bias monitoring to ensure equitable
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Methodology
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        Methodology
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../methodology/lightweight/" title="Lightweight approach" class="md-nav__link">
      Lightweight approach
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../methodology/" title="Integrated iterative approach" class="md-nav__link">
      Integrated iterative approach
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Reference Implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        Reference Implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-ai-data-customer-churn/" title="Customer churn solution" class="md-nav__link">
      Customer churn solution
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#context" title="Context" class="md-nav__link">
    Context
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#distributed-data" title="Distributed data" class="md-nav__link">
    Distributed data
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#replication" title="Replication" class="md-nav__link">
    Replication
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-leader" title="Single leader" class="md-nav__link">
    Single leader
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-leader" title="Multi leader" class="md-nav__link">
    Multi leader
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compendium" title="Compendium" class="md-nav__link">
    Compendium
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ibm-cloud-architecture/refarch-data-ai-analytics/edit/master/docs/data/data-intensive-app.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="designing-data-intensive-applications">Designing Data intensive applications</h1>
<p>In this article we are highlighting some practice to design data intensive application and microservice solution. This is strongly linked to the adoption of event-driven microservices, but address the data consistency and eventual data consitency discussions, as well as the different strategies for implementation.</p>
<p>Started 10/30/2019, still under heavy work.</p>
<h2 id="context">Context</h2>
<p>A typical modern business solution will include a set of microservices working together in choreography to exchange data. The adoption of event-driven microservice with all related design pattern is described in separate articles that you can read <a href="https://ibm-cloud-architecture.github.io/refarch-eda/design-patterns/ED-patterns/">here</a>. </p>
<p>When zooming to a particular data intensive microservice we will find a set of important data centric features that may look like in the diagram below:</p>
<p><img alt="Data Intensive App" src="../images/data-intensive-app.png" /></p>
<p>The components involved include:</p>
<ul>
<li>Databases to store data for long term</li>
<li>Caches to speed up retrieving data from expensive operation</li>
<li>Search indexes to support search on a corpus</li>
<li>Stream processing to pub/sub messages with other processes, which are now also considered as long duration datastores (Kafka).</li>
<li>Batch processing to move large data between data sources</li>
</ul>
<p>When designing such application we need to address a set of important subjects:</p>
<ul>
<li>How to ensure data correctness and completeness?</li>
<li>How to address good performance when exposing data, even when app is running slowly?</li>
<li>How to scale and address increase in transaction volume and data size increase?</li>
<li>What data to expose to other services via messaging ?</li>
<li>What data to expose to other services via APIs ?</li>
<li>How to support application reliability when some components are not performing within their SLA? How to be fault-tolerant?</li>
<li>How to test fault-tolerance?</li>
<li>How adding horizontal compute power impact the data access?</li>
</ul>
<p>In modern big data applications, hardware redundancy is not suffisant, the design needs to support unexpected faults, to avoid cascading failures and to support new version deployment with rolling-upgrade capability. </p>
<p>When addressing scalability and load growth, we need to define the load parameters: number of transaction per second, or number of read and write operation, number of active sessions, ... On average and at peak. Each microservice in a solution will have its own load parameters. </p>
<p>From there we need to design to address the following issue:</p>
<ul>
<li>How does load growth impact performance while keeping existing compute resources?</li>
<li>What is the increase of compute resource needed to support same performance while load growth?</li>
</ul>
<p>The solution problem is a combination of different characteristics to address: read volume, write volume, data store volume, data complexity, response time, access logic...</p>
<p>For batch processing the measurment is the throughput: number of records per second or time to process n records. For real time processing the response time measures the time to get a response from a client's point of view after sending a request.</p>
<p>When defining service level agreement, it is important to use the median response time and a percentile of outliers. An example the median could be at 300ms at P99 (99/100) under 1s.</p>
<p>Tail latencies, or high percentils of response time, impacts directly user experience and cost money.</p>
<h2 id="distributed-data">Distributed data</h2>
<p>Adopting microservice architecture, means distributed systems and distributed data. The main motivations for that are scalability (data operations load could not be supported by one server), high availability (by sharing the same processing between multiple machines), and reducing latency to distribute data close to the end users.</p>
<p>Vertical scaling is still bounded by hardware resources, so at higher load we need to support horizontal scaling by adding more machine in cluster or in multiple clusters.  When adding machines, we may want to adopt different techniques for data sharing: </p>
<ul>
<li>shared memory</li>
<li>shared storage</li>
<li>shared nothing: cpu, memory and disk are per node. Cluster manages node orchestration over network. This architecture brings new challenges. </li>
</ul>
<h3 id="replication">Replication</h3>
<p>A first technique to  share data is to replicate or copy data between nodes. It fits well, when dataset is small enough to be persisted in one machine, and when data do not change a lot over time. Replication implementations are most of the time, black box for business application developers, but for clarity we can mention three types:</p>
<ul>
<li>
<p><strong>single-leader</strong>: one of the replica is the leader, and receive write operations from client services. Other replicas are followers, listening to data updates from a replication log and modify their own data store. Read operations can happen on any node, and followers are specifically read-only. This is a pattern used by Kafka, Postgresql, RabbitMQ...</p>
<p><img alt="Leader-Followers" src="../images/leader-followers.png" /></p>
</li>
<li>
<p><strong>multi-leader</strong>: multiple nodes accept write operations (they are leaders), and act as follower for other leaders. </p>
</li>
<li><strong>leaderless</strong>: each node accept write operations. Client sends write to multiple replicas, accept p acknowledge (p &lt;= number of nodes), but also performs n reads to assess eventual stale data. (This type is used in Cassandra or DynamoDB)</li>
</ul>
<h4 id="single-leader">Single leader</h4>
<p>Replication can be done synchronously or asynchronously. With synchronous the leader waits until at least one follower has comfirmed replication before reporting to the client that the write operation is successful. From the client point of view, it is a synchronous call.</p>
<p><img alt="Synch-Asynch" src="../images/synch-asynch.png" /></p>
<p>With asynchronous the leader does not wait for followers to replicate. With synchronous, we are sure the data are not lost as at least one follower responded, but if the follower node has failure then the write operation is not consider completed, even if leader has the data. The client can do a retry. But the leader may need to block other write requests until it sees a follower alive. With synch, the data is also consistent with the leader. The figure above illustrates a synchronous mechanism for client - leader and first follower to respond, and asynchronous for the other followers.</p>
<p>It is important to note that asynch replica may be the only possible solution when the number of followers is important or when they are separated by long distance with high latency networking communication.  Because a full synchronous mechanism will block the write operations in case of a follower failure and will not be reliable.</p>
<p>With asynch, two reads at the same time on the leader and one of the follower will not get the same results. This inconsistency is temporal: when there is no more write then the followers will become eventually consistent. This elapse time is called replication lag.</p>
<p><img alt="" src="../images/asynch.png" /></p>
<p>This lag can have some interesting derived issues, like seeing data in one query (done on a follower with small lag) and then not seeing the data from the same query done on a bigger lagged follower. To avoid that the pratice is to use a monolitic read: user makes several reads in sequence, they will not see time go backward. Which can be achieved by ensuring the reads for a given user are done on the same follower. This is what kafka does by assigning a consumer to partition.</p>
<p>With asynch replica, if the leader fails, data not yet replicated are lost until a new leader starts to accept new writes. </p>
<p><img alt="" src="../images/data-lost.png" /></p>
<p>Also adding a new follower brings other challenges: as the data are continuously being written to the leader database, copying the database files to the new follower will not be consistent. One adopted solution is to snapshot the database, without locking write operations, and copy the data to the follower, then from this snapshot, consumes the update log. To work the snapshot position needs to be known in the replication log. </p>
<p><img alt="" src="../images/add-follower.png" /></p>
<p>To support follower failure, the log needs to keep position of the last commited read, so when the follower restarts, it can load data from this position in the log. </p>
<p>When the leader fails, a follower needs to take the leadership, and then other followers need to get data from the new leader. Kafka, combined with zookeeper, uses those last two mechanisms to support replication. Selecting the new leader is based on consensus algorithm, to ensure minimum data lost.  </p>
<p>When using single leader, it is possible to reach a split brain state, when the old leader comes back to live, and thinks it is still a leader: both leaders accept writes which leads to data corruption. </p>
<h4 id="multi-leader">Multi leader</h4>
<p>With multi leader configuration each leader gets write operations, and propagate data update notifications to all nodes. This is an active-active replication. And it is the practice when dealing with multiple datacenters. </p>
<p><img alt="" src="../images/multi-lead.png" /></p>
<p>The write operations are propagated asynchronously which is more permissive to network failure. It is important to note that the following problems need to be addressed with this topology:</p>
<ul>
<li>Update of the same data at the same time, leading to write conflict</li>
<li>Automatic primary key generation by the database may create duplicate keys</li>
<li>Triggers that work on conditions on the data to do something could never be triggered due to data conditions that will never happen in this active - active configuration.</li>
<li>Integrity constraints can be violated, as one records may be processed without the others being yet present.</li>
</ul>
<p>For the write conflict resolution, there are different strategies, one uses timestamps so the last write wins the record update, but this cloud lead to data lost. In fact conflict resolution will be dependant of the business logic and data knowledge. So custom code needs to be done to apply this logic to write conflicts.</p>
<p>When there is more than two leaders, the replicas topology can be done in ring, start or all-to-all:</p>
<p><img alt="" src="../images/multi-lead-topo.png" /></p>
<p>With Ring, a leader forward and propagate its own write to one neighbor. With star one designated root node forwards writes to all of the other nodes. Finally with all-to-all, every leader sends its writes to every other leader.</p>
<p>With Ring and Start, a node failure impacts the data replication to any node, and with all to all we need to address looping on the same write. The mitigation is to use a unique identifier for each node, so a write event coming with the same node_id of the current node id is discarded.</p>
<h2 id="compendium">Compendium</h2>
<ul>
<li><a href="https://www.amazon.com/Designing-Data-Intensive-Applications-Reliable-Maintainable/dp/1449373321/ref=sr_1_3?crid=F3G6F7KYQZMH&amp;keywords=designing+data+intensive+applications&amp;qid=1572566804&amp;sprefix=designing+data+%2Caps%2C204&amp;sr=8-3">Designing data intensive application - Martin Kleppmann</a></li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../preparation/" title="Model selection" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Model selection
              </span>
            </div>
          </a>
        
        
          <a href="../../deployment/" title="CI & CD" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                CI & CD
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.b806dc00.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>